# NHPflex2025

**Project:** Flexible electrode systems for non-human primates (NHPs)

This repository accompanies a bioRxiv preprint describing the design, fabrication, and use of flexible neural probes and associated hardware for chronic recordings in non-human primates. It contains all files needed to reproduce the figures in the manuscript, design and fabrication data for probes and PCBs, 3D designs for a microdrive adapter, and the analysis code used in the study.

**Repository Contents**
- **`/data/neurons/`**: Neuron spike files (processed and raw spike-sorted outputs).
- **`/data/drift/`**: Drift measurements and calibration data used in analyses.
- **`/data/raw/fig1-5/`**: Raw and preprocessed datasets used to generate Figures 1–5.
- **`/data/raw/supp_fig1-5/`**: Raw datasets used to generate Supplementary Figures 1–5.
- **`/probes/`**: Probe fabrication files, masks, and CAD used for probe layout.
- **`/pcb/`**: PCB design files and Gerbers for electronics supporting the probes.
- **`/fabrication/`**: Link and step-by-step notes for the probe fabrication process (see `README` inside folder).
- **`/3d/`**: 3D design files (STEP, STL) for the microdrive adapter and mounting parts.
- **`/matlab/`**: All MATLAB analysis code (.m scripts and .mat data files) used in the manuscript. Subfolders include `figures/` with scripts to reproduce each figure.
- **`/figures/`**: Reconstructed figure images generated by the analysis scripts.
- **`/docs/`**: Additional documentation, protocol notes, and ethical approvals metadata (redacted as necessary).

**How to Use This Repository (MATLAB-centric)**
- Reproduce figures: each figure (1–5) has a dedicated MATLAB script under `matlab/figures/fig1` ... `matlab/figures/fig5`. The scripts are written to load `.mat` data files from `data/` and produce the figures saved to `figures/`.

- Example (interactive MATLAB):

```
cd matlab/figures/fig1
addpath(genpath(fullfile('..','..')))
run('run_figure1.m')
```

- Example (headless / batch from bash):

```
matlab -batch "addpath(genpath(pwd)); run('matlab/figures/fig1/run_figure1.m')"
```

-- MATLAB requirements: scripts were developed and tested with **MATLAB R2022a**. Required MathWorks toolboxes used in the analyses include:
	- Signal Processing Toolbox
	- Statistics and Machine Learning Toolbox
	- Image Processing Toolbox (where used)

	In addition the analysis uses two community toolboxes:
	- `matlabnpy` — a lightweight toolbox to read/write NumPy `.npy`/`.npz` files directly from MATLAB. Install by cloning and adding to your MATLAB path; for example:

	```matlab
	git clone https://github.com/kwikteam/matlabnpy.git external/matlabnpy
	addpath(genpath(fullfile(pwd,'external','matlabnpy')))
	```

	- Open Ephys Analysis Toolbox — used to load and preprocess Open Ephys recordings. Install by cloning the repository and adding it to the MATLAB path; for example:

	```matlab
	git clone https://github.com/open-ephys/analysis-tools.git external/open-ephys-analysis
	addpath(genpath(fullfile(pwd,'external','open-ephys-analysis')))
	```

	See each figure's `README.md` for exact version notes and any additional third-party functions. If you do not have MATLAB, some scripts can be compiled with MATLAB Compiler or run as standalone using the MATLAB Runtime (see individual figure `README.md` files for details).

**Probe Fabrication & PCB**
- The `probes/` directory contains CAD, mask layouts, and fabrication notes. The `pcb/` directory contains the PCB schematics, KiCad project files, and Gerber exports.
- Fabrication process (detailed steps and external resources) are in `fabrication/README.md`. For the fabrication service used in this work, see: [Probe fabrication process & vendor link](https://example-probe-fab.example.com) (replace with actual link when available).

**3D Designs**
- The `3d/` folder includes STEP and STL files for the microdrive adapter used to mount flexible probes. CAD source (SolidWorks/FreeCAD) files are included where licensing permits.

**Data Availability & Ethical Considerations**
- Raw and processed data used to generate manuscript figures are provided under `data/` with clear README files describing formats and provenance.
- Some NHP data may contain sensitive metadata; files that require access control are flagged and the repository includes instructions for requesting access.

- Animal care and use compliance: All animal procedures reported in the accompanying preprint were performed in accordance with institutional and national guidelines and were approved by the Institutional Animal Care and Use Committee (IACUC). See `docs/ethics.md` for an explicit IACUC statement and placeholders to record the performing institution, protocol numbers, and approval dates. Replace the placeholders in `docs/ethics.md` with your institution-specific details before public release.

**Reproducing Figures (summary)**
- Each `matlab/figures/figX` folder includes a `README.md` describing inputs (which `.mat` files are required), preprocessing steps, and the exact MATLAB command(s) to run.
- Typical workflow to reproduce a figure:
	- Ensure MATLAB (R2022a+) and required toolboxes are available.
	- Download or point to required `.mat` data in `data/raw/`.
	- Run the `run_figureX.m` script either interactively or with `matlab -batch` as shown above.

**Code Organization (MATLAB)**
- `matlab/processing/`: preprocessing scripts and wrappers (e.g., data cleaning, filtering, spike-sorting call wrappers).
- `matlab/analysis/`: core analysis functions used across figures (modular `.m` functions).
- `matlab/figures/`: figure-specific pipelines and `run_figureX.m` scripts that generate figure panels from `.mat` inputs.
- `matlab/utils/`: utility functions for file I/O, plotting styles, and reproducible random seeds.

**Citation**
When using these data or code, please cite the accompanying preprint:

Author(s). Title. bioRxiv (Year). DOI/URL

Example citation (replace with actual):
Gonzales Lab et al., Flexible electrodes for chronic NHP recordings, bioRxiv, 2025. https://doi.org/xxxx

**License**
- **Code:** The analysis code, scripts, and design files in this repository are provided under the `MIT` license. See `LICENSE` for full terms.
- **Data:** By default the repository's data are offered under a permissive data license: `Creative Commons Attribution 4.0 International (CC BY 4.0)`. See `DATA_LICENSE.md` for details and citation requirements. If a different license applies to a specific dataset in `data/`, that dataset's folder will contain an explicit license file.

**Contributing & Contact**
- Contributions and corrections welcome. Please open an issue or submit a pull request.
- Contact lead author: `lead.author@example.edu` (replace with real contact)

**Acknowledgements**
- List funding sources, collaborators, and fabrication partners in `ACKNOWLEDGEMENTS.md`.

---
If you want, I can also scaffold the folder structure and add minimal example files and run scripts. Would you like me to create that now?