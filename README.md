# NHPflex2025

**Project:** Stable, acute recordings in behaving non-human primates using flexible microelectrodes 

This repository accompanies a bioRxiv preprint describing the design, fabrication, and use of flexible neural probes and associated hardware for acute recordings in non-human primates. It contains all files needed to reproduce the figures in the manuscript, design and fabrication data for probes and PCBs, 3D designs for a microdrive adapter, and the analysis code used in the study.

**Repository Contents**
- **`/data/neurons/`**: Neuron spike files.
- **`/data/drift/`**: Drift metrics used in analyses, built off of KiloSort4 drift correction.
- **`/data/raw/fig1-5/`**: Datasets used to generate Figures 1–5.
- **`/data/raw/supp_fig1-5/`**: Datasets used to generate Supplementary Figures 1–5.
- **`/probes/`**: Probe mask files used for layout.
- **`/pcb/`**: PCB design files and Gerbers for electronics supporting the probes.
- **`/fabrication/`**: Link and step-by-step notes for the probe fabrication process (see `README` inside folder).
- **`/3d/`**: 3D design files (STEP, STL) for the microdrive adapter and mounting parts.
- **`/matlab/`**: All MATLAB analysis code (.m scripts) used in the manuscript. Subfolders include `figures/` with scripts to reproduce each figure.
- **`/figures/`**: Reconstructed figure images generated by the analysis scripts.
- **`/docs/`**: Additional documentation, protocol notes, etc.

## How to Use This Repository

### Quick Start: Reproducing Figures

Each figure (1–5) has a dedicated MATLAB script under `matlab/figures/figX/`. Scripts load `.mat` data files from `data/` and generate figures saved to `figures/`.

**Interactive MATLAB:**
```matlab
cd matlab/figures/fig1
addpath(genpath(fullfile('..','..')))
run('run_figure1.m')
```

**Batch/Headless (bash):**
```bash
matlab -batch "cd matlab/figures/fig1; addpath(genpath(fullfile('../../'))); run('run_figure1.m')"
```

### MATLAB Requirements

Scripts were developed and tested with **MATLAB R2022a**. 

**Required MathWorks Toolboxes:**
- Signal Processing Toolbox
- Statistics and Machine Learning Toolbox
- Image Processing Toolbox (where used)

**Required Community Toolboxes:**
- **`matlabnpy`** — lightweight toolbox to read/write NumPy `.npy`/`.npz` files directly from MATLAB
- **Open Ephys Analysis Toolbox** — load and preprocess Open Ephys recordings

### Setting Up External Toolboxes

**Option 1: Automated (recommended)**
```bash
bash scripts/setup_external_toolboxes.sh
```

**Option 2: Manual clone**
```bash
mkdir -p external
git clone https://github.com/kwikteam/matlabnpy.git external/matlabnpy
git clone https://github.com/open-ephys/analysis-tools.git external/open-ephys-analysis
```

**Add to MATLAB path (from MATLAB):**
```matlab
addpath(genpath(fullfile(pwd,'external','matlabnpy')))
addpath(genpath(fullfile(pwd,'external','open-ephys-analysis')))
savepath;
```

Or use the included helper:
```matlab
run('matlab/add_external_paths.m')
```

See each figure's `README.md` for version notes and additional dependencies. If you do not have MATLAB, scripts can be compiled with MATLAB Compiler or run standalone using the MATLAB Runtime (see individual figure READMEs).

## Probe Fabrication & PCB

- **`probes/`** directory: Mask layouts and fabrication notes for probe design.
- **`pcb/`** directory: PCB schematics, Fusion360 project files, and Gerber exports for electronics.
- **Fabrication process:** Detailed steps and vendor links are in `fabrication/README.md`. 
- **Fabrication service:** See the [probe fabrication process & vendor link](https://www.fabublox.com/process-editor/899ce03e-38a6-4836-bd59-ae51e0551a5e) for detailed instructions and availability.

## 3D Designs

- The `3d/` folder contains STEP and STL files for the microdrive adapter used to mount flexible probes.
- Adapter is designed for the [Narishige MO-97A hydraulic micromanipulator]([https://narishige.co.jp/en/products/micromanipulators/mo97a/](https://products.narishige-group.com/group1/MO-97A/chronic/english.html)).
- Fabricated using a Formlabs Form 3 with clear resin (±0.025 mm tolerance). See `3d/README.md` for specifications.

## Data Availability & Ethical Considerations

- **Data location:** Raw and processed data are provided under `data/` with README files describing formats and provenance.
- **Sensitive metadata:** Some NHP data may contain sensitive information; access-controlled files are flagged with instructions for requesting access.
- **Animal care compliance:** All animal procedures were performed in accordance with institutional and national guidelines and approved by the Institutional Animal Care and Use Committee (IACUC). See `docs/ethics.md` for explicit IACUC statement with placeholders for institution, protocol numbers, and approval dates.

## Reproducing Figures

- Each `matlab/figures/figX` folder contains a `README.md` describing required `.mat` files, preprocessing steps, and exact MATLAB commands.
- **Typical workflow:**
  1. Ensure MATLAB R2022a+ and required toolboxes are installed.
  2. Set up external toolboxes using the steps above.
  3. Obtain required `.mat` data files from `data/raw/figX/`.
  4. Run `run_figureX.m` interactively or via batch command (see Quick Start above).

## Code Organization (MATLAB)

- **`matlab/processing/`** — Preprocessing scripts and wrappers (data cleaning, filtering, spike-sorting integration).
- **`matlab/analysis/`** — Core analysis functions reused across figures (spike analysis, decoding, statistics, etc.).
- **`matlab/figures/`** — Figure-specific scripts (`run_figureX.m`) that generate figure panels from `.mat` inputs.
- **`matlab/utils/`** — Utility functions (file I/O, plotting styles, random seeds, reproducibility helpers).

## Citation

When using these data or code, please cite the accompanying preprint:

**Example:**
> Woods et al., Stable, acute recordings in behaving non-human primates using flexible microelectrodes, bioRxiv, 2026. https://doi.org/xxxx

See individual figure READMEs for data-specific citations where applicable.

## License

- **Code:** Analysis code, scripts, and design files are provided under the `MIT` license (see `LICENSE`).
- **Data:** Data are offered under `Creative Commons Attribution 4.0 International (CC BY 4.0)` (see `DATA_LICENSE.md` for details and citation requirements). If a specific dataset has a different license, it will be noted in that folder.

## Contact & Acknowledgements

- **Lead Author:** daniel.p.woods@vanderbilt.edu
- **Issues & PRs:** Contributions and corrections are welcome. Please open an issue or submit a pull request.
- **Funding & Acknowledgements:** The HHMI Hanna Gray Fellowship and the Burroughs Wellcome Fund funded this work. Owen Meilander assisted with sample fabrication within the Vanderbilt Institute for Nanoscale Science and Engineering. We thank Jaela Bills and Kayla Yetman for technical help with experiments. For additional acknowledgements, see `ACKNOWLEDGEMENTS.md`.

---

*Last updated: December 2025*
